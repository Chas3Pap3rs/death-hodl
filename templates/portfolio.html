{% extends 'base.html' %}
{% block title %}
Cartera
{% endblock title %}
{% block content %}

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-success" role="alert">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}

<div class="main-container">
  <h1 class="mb-4">REFERRALS</h1>
  <div class="my-4 py-3 px-4 rounded-lg referral-code">
    <div class="d-flex align-items-center justify-content-between">
      <p class="mb-0">Your Referral Code is <strong>http://localhost:8000/signup/{{ referral_code }}</strong></p>
      <button class="btn btn-dark btn-md copy-btn" onclick="sendToClipboard()"><i class="fas fa-copy"></i></button>
    </div>

    <p class="ml-0 mt-3 mb-0"><a href="http://localhost:8000/signup/{{ referral_code }}">Share this link with your friends to earn 100 points for each friend who signs up!</a></p>
  </div>


  {% if referrals %}
  <div class="mb-5">
    <table class="table table-striped table-hover custom-table mt-5">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Referral User</th>
          <th scope="col">Date Joined</th>
        </tr>
      </thead>
      <tbody>
        {% for referral in referrals %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ referral.user }}</td>
            <td>{{ referral.user.date_joined }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if total_bonus >= 0 %}
    <div class="row mt-5">
      <div class="col-md-6">
        <div class="alert alert-success py-3 mb-3">
          <h4 class="mb-0 text-dark">Total Referrals</h4>
          <p class=" ml-3 mb-0 display-4">{{ referrals|length }}</p>
        </div>
      </div>
      <div class="col-md-6">
        <div class="alert alert-info py-3 mb-3">
          <h4 class="mb-0">Total Points Earned</h4> 
          <p class=" ml-3 mb-0 display-4">{{ total_bonus }}</p>
        </div>
      </div>
    </div>
    {% endif %}

    <form method="POST" action="{% url 'trade_in_points' %}">
      {% csrf_token %}
      <input type="submit" value="Trade in Points">
    </form>
  </div>
  {% else %}
  <div class="alert alert-danger my-4 p-3 rounded text-center text-light">
    You have not referred any friends yet.
  </div>

  {% endif %}

  <h1 class="mb-4 mt-5 custom-heading">{{ current_user|upper }}'s Purse</h1>

  {% if user_cryptocurrencies %}
    <div class="table-responsive">
      <table class="table table-striped mb-4 mt-2 custom-table">
        <thead>
          <tr>
            <th class="table-header" scope="col">Cryptocurrency</th>
            <th class="table-header" scope="col">Current Price</th>
            <th class="table-header" scope="col">Amount Owned</th>
            <th class="table-header" scope="col">Total Value</th>
            <th class="table-header" scope="col">24h %</th>
            <th class="table-header" scope="col">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for crypto in user_cryptocurrencies %}
            <tr>
              <td>{{ crypto.name }}</td>
              <td>{{ crypto.current_price|floatformat:2 }}</td>
              <td>{{ crypto.quantity }}</td>
              <td>{{ crypto.total_value|floatformat:2 }}</td>
              <td>{{crypto.price_change_percentage_24h|floatformat:3 }}
                {% if crypto.price_change_percentage_24h > 0 %}
                  <i class="fa fa-arrow-up green-arrow"></i>
                {% else %}
                  <i class="fa fa-arrow-down red-arrow"></i>
                {% endif %} 
              </td>
              <td>
                <a href="{% url 'sell' crypto.id %}"><i class="fa fa-dollar-sign green-arrow"></i></a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}

    <div class="alert alert-info py-3 mb-3 fancy-color">
      <div><h4 class="mb-0 text-light">Total Portfolio Value</h4></div>
      <div><p class="display-4 text-light mb-0"> ${{ total_value|floatformat:2 }}</p></div>
      <div>
        <h4 class="cash-amount">Cash Balance: ${{ portfolio.cash_balance }}</h4>
        <h4 class="crypto-balance">Crypto Holdings: ${{ portfolio.crypto_value|floatformat:2 }}</h4>
      </div>
    </div>

      
    {% if user_cryptocurrencies %}
      <div id="portfolio-chart"></div>
    
      <script>
        var ctx = document.getElementById('portfolio-chart').getContext('2d');
        var chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: [ {% for crypto in user_cryptocurrencies %}{{ crypto.name }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
              label: 'Cryptocurrency Quantity',
              data: [ {% for crypto in user_cryptocurrencies %}{{ crypto.quantity }}{% if not forloop.last %}, {% endif %}{% endfor %} ],
              backgroundColor: [ 'rgba(255, 99, 132, 0.2)', 'rgba(54, 162, 235, 0.2)', 'rgba(255, 206, 86, 0.2)', 'rgba(75, 192, 192, 0.2)', 'rgba(153, 102, 255, 0.2)' ]
            }]
          },
          options: {
            legend: {
              display: false
            },
            scales: {
              xAxes: [{
                stacked: true
              }],
              yAxes: [{
                stacked: true
              }]
            }
          }
        });
      </script>
    
  {% else %}
  <div class="alert alert-danger my-3 p-3 rounded text-center text-light">
    You don't have any cryptocurrencies in your portfolio.
  </div>
  {% endif %}

  <div>
    <p><a class="btn btn-get-crypto" href="{% url 'home' %}">Add Cryptocurrencies</a></p>
    <a class="btn btn-reset-portfolio" href="{% url 'reset_portfolio' %}">Reset Portfolio</a>
    <a class="btn btn-delete-account" href="{% url 'delete_account' %}">Delete my account</a>
  </div>

  

  <br><br><br><br>
  <script>
    function sendToClipboard() {
      var copyText = document.querySelector(".referral-code strong");
      copyText.textContent = "http://localhost:8000/signup/" + copyText.textContent;
      var textArea = document.createElement("textarea");
      textArea.value = copyText.textContent;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand("Copy");
      textArea.remove();
      alert("Copied to clipboard");
    }
  </script>
</div>
{% endblock %}
